/*
 * Arduino Nano BLE - Ultrasonic Sensor with Continuous Servo Scanning
 * FIXED: Servo continuously alternates between wall side and front
 * 
 * The servo scans:
 * - 90° (Front) - always
 * - 0° or 180° (Wall side) - determined by which side has closer reading
 */

#include <Servo.h>

// Pin definitions
#define TRIG_PIN 2
#define ECHO_PIN 3
#define SERVO_PIN 4

Servo scanServo;

// Angles
const int FRONT_ANGLE = 90;
int wallAngle = 0;  // Will be set to 0 (right) or 180 (left)

// State
bool scanningFront = true;
bool wallSideDetected = false;
int detectionAttempts = 0;

void setup() {
  Serial.begin(9600);
  
  // Ultrasonic sensor pins
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  
  // Attach servo
  scanServo.attach(SERVO_PIN);
  scanServo.write(FRONT_ANGLE); // Start at front position
  
  delay(1000); // Allow servo to reach position
  Serial.println("Arduino Nano - Starting sensor scan");
}

void loop() {
  // Detect wall side in first few scans
  if (!wallSideDetected && detectionAttempts < 10) {
    detectWallSide();
    detectionAttempts++;
    return;
  }
  
  // If still not detected after 10 attempts, default to right side
  if (!wallSideDetected) {
    wallAngle = 0;
    wallSideDetected = true;
    Serial.println("Defaulting to RIGHT side");
  }
  
  // Continuous alternating scan
  if (scanningFront) {
    // Scan front
    scanAndReport(FRONT_ANGLE);
    scanningFront = false;
  } else {
    // Scan wall side
    scanAndReport(wallAngle);
    scanningFront = true;
  }
  
  delay(100); // Small delay between scans
}

void detectWallSide() {
  // Measure right side (0°)
  scanServo.write(0);
  delay(400);
  float distRight = getDistance();
  
  // Measure left side (180°)
  scanServo.write(180);
  delay(400);
  float distLeft = getDistance();
  
  Serial.print("Detection - Right: ");
  Serial.print(distRight);
  Serial.print(" Left: ");
  Serial.println(distLeft);
  
  // Determine which side has the wall (closer distance)
  // Valid wall distance: 10-50cm
  bool rightValid = (distRight > 10 && distRight < 50);
  bool leftValid = (distLeft > 10 && distLeft < 50);
  
  if (rightValid && leftValid) {
    // Both sides have readings, pick the closer one
    wallAngle = (distRight < distLeft) ? 0 : 180;
    wallSideDetected = true;
    Serial.print("Wall detected on BOTH sides, using closer: ");
    Serial.println(wallAngle == 0 ? "RIGHT" : "LEFT");
  } else if (rightValid) {
    wallAngle = 0;
    wallSideDetected = true;
    Serial.println("Wall detected on RIGHT");
  } else if (leftValid) {
    wallAngle = 180;
    wallSideDetected = true;
    Serial.println("Wall detected on LEFT");
  }
  
  // Move to front position after detection
  scanServo.write(FRONT_ANGLE);
  delay(400);
}

void scanAndReport(int angle) {
  // Move servo to target angle
  scanServo.write(angle);
  delay(300); // Wait for servo to reach position
  
  // Measure distance
  float distance = getDistance();
  
  // Send data: distance,angle
  Serial.print(distance);
  Serial.print(",");
  Serial.println(angle);
}

float getDistance() {
  // Send trigger pulse
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);
  
  // Read echo pulse
  long duration = pulseIn(ECHO_PIN, HIGH, 30000); // 30ms timeout
  
  // Calculate distance in cm
  float distance = duration * 0.034 / 2.0;
  
  // Return 0 if out of range or error
  if (distance == 0 || distance > 400) {
    return 0;
  }
  
  return distance;
}
