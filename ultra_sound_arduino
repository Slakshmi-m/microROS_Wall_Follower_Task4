/*
 * Arduino Nano BLE - Ultrasonic Sensor with Servo Controller
 * Assignment Mode: Alternates between WALL side and FRONT (90째 rotations)
 * 
 * The servo will scan:
 * - 90째 (Front)
 * - 0째 or 180째 (Wall side - automatically determined)
 * 
 * Output format: distance,angle
 */

#include <Servo.h>

// Pin definitions
#define TRIG_PIN 2
#define ECHO_PIN 3
#define SERVO_PIN 4

Servo scanServo;

// Initial angles - will be modified once wall side is detected
int frontAngle = 90;
int wallAngle = 0;  // Start checking right side, will switch to 180 if wall is on left

// Scanning state
bool scanningFront = true;
bool wallSideDetected = false;

void setup() {
  Serial.begin(9600);
  
  // Ultrasonic sensor pins
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  
  // Attach servo
  scanServo.attach(SERVO_PIN);
  scanServo.write(frontAngle); // Start at front position
  
  delay(1000); // Allow servo to reach position
}

void loop() {
  int currentAngle;
  
  if (scanningFront) {
    // Scan front
    currentAngle = frontAngle;
    servoMoveAndMeasure(currentAngle);
    scanningFront = false;
  } else {
    // Scan wall side
    if (!wallSideDetected) {
      // Check right side first
      currentAngle = 0;
      servoMoveAndMeasure(currentAngle);
      float distRight = getDistance();
      
      // If wall detected on right (between 10-30cm), use right side
      if (distRight > 10 && distRight < 30) {
        wallAngle = 0;
        wallSideDetected = true;
        Serial.print(distRight);
        Serial.print(",");
        Serial.println(0);
        delay(100);
      } else {
        // Check left side
        currentAngle = 180;
        servoMoveAndMeasure(currentAngle);
        float distLeft = getDistance();
        
        if (distLeft > 10 && distLeft < 30) {
          wallAngle = 180;
          wallSideDetected = true;
          Serial.print(distLeft);
          Serial.print(",");
          Serial.println(180);
          delay(100);
        }
      }
    } else {
      // Wall side already detected, scan that side
      currentAngle = wallAngle;
      servoMoveAndMeasure(currentAngle);
    }
    scanningFront = true;
  }
  
  delay(100);
}

void servoMoveAndMeasure(int angle) {
  // Move servo to angle
  scanServo.write(angle);
  delay(300); // Wait for servo to stabilize
  
  // Measure distance
  float distance = getDistance();
  
  // Send data: distance,angle
  Serial.print(distance);
  Serial.print(",");
  Serial.println(angle);
}

float getDistance() {
  // Send trigger pulse
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);
  
  // Read echo pulse
  long duration = pulseIn(ECHO_PIN, HIGH, 30000); // 30ms timeout
  
  // Calculate distance in cm
  float distance = duration * 0.034 / 2.0;
  
  // Return 0 if out of range or error
  if (distance == 0 || distance > 400) {
    return 0;
  }
  
  return distance;
}